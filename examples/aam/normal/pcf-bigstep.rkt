#lang racket/base
(require lightstep/base lightstep/syntax lightstep/inference
         (only-in "pcf.rkt" PCF Î´))
(provide PCFâ‡“)

(module+ test (require rackunit))

;;-----------------------------------------------------------------------------
;; 3.4 Evaluation

(define-language PCFâ‡“ #:super PCF
  [V âˆ·= N O
        `(,L ,(? Ï?))
        `((Î¼ [,X : ,T] ,L) ,(? Ï?))]
  [Ï âˆ·= (? map? Xâ†’V)])

;; M Ï â‡“ V
(define-inference (â‡“-rules)
  #:do [(define (ext Î“ xs vs)
          (foldr (Î» (x v Î“) (Î“ x v)) Î“ xs vs))]
  #:forms ([`(,M:i ,Ï:i â‡“ ,V:o) #:where V â† (â‡“-rules `(,M ,Ï))])

  [------------------
   `(,N ,(? Ï?) â‡“ ,N)]

  [------------------
   `(,O ,(? Ï?) â‡“ ,O)]

  [-------------------------
   `(,L ,(? Ï? Ï) â‡“ (,L ,Ï))]

  [-----------------------------------------------------
   `((Î¼ [,X : ,T] ,L) ,(? Ï? Ï) â‡“ ((Î¼ [,X : ,T] ,L) ,Ï))]

  [V â‰” (Ï X)
   --------------------
   `(,X ,(? Ï? Ï) â‡“ ,V)]

  [`(,Mâ‚€ ,Ï â‡“ ,N)
   M â‰” (if (zero? N) Mâ‚ Mâ‚‚)
   `(,M ,Ï â‡“ ,V)
   -----------------------------------
   `((if0 ,Mâ‚€ ,Mâ‚ ,Mâ‚‚) ,(? Ï? Ï) â‡“ ,V)]

  [`(,Mâ‚€ ,Ï â‡“ ,O)
   `(,Nâ‚ ...) â† (mapM (Î» (m) (â‡“-rules `(,m ,Ï))) Mâ‚)
   N â‰” (Î´ `(,O ,@Nâ‚))
   -------------------------------------------------
   `((,Mâ‚€ ,Mâ‚ ...) ,(? Ï? Ï) â‡“ ,N)]

  [`(,Mâ‚€ ,Ï â‡“ ((Î» ([,Xâ‚ : ,T] ...) ,M) ,Ïâ‚))
   `(,Vâ‚ ...) â† (mapM (Î» (m) (â‡“-rules `(,m ,Ï))) Mâ‚)
   `(,M ,(ext Ïâ‚ Xâ‚ Vâ‚) â‡“ ,V)
   -------------------------------------------------
   `((,Mâ‚€ ,Mâ‚ ...) ,(? Ï? Ï) â‡“ ,V)]

  [`(,Mâ‚€ ,Ï â‡“ ,(and f `((Î¼ [,Xâ‚ : ,Tâ‚] (Î» ([,Xâ‚ : ,T] ...) ,M)) ,Ïâ‚)))
   `(,Vâ‚ ...) â† (mapM (Î» (m) (â‡“-rules `(,m ,Ï))) Mâ‚)
   `(,M ,(ext Ïâ‚ (cons Xâ‚ Xâ‚) (cons f Vâ‚)) â‡“ ,V)
   -------------------------------------------------------------------
   `((,Mâ‚€ ,Mâ‚ ...) ,(? Ï? Ï) â‡“ ,V)                                    ])

;; M Ï â†’ ğ’«(V)
(define (â‡“ M Ï) (letrec-values ([(mrun reducer) (â‡“-rules)])
                  (mrun (reducer `(,M ,Ï)))))

;; M Ï V â†’ Boolean
(define (â‡“? M Ï v) (âˆˆ v (â‡“ M Ï)))

(module+ test
  (require (only-in (submod "pcf.rkt" test) fact-5))

  (check-equal? (â‡“ fact-5 (â†¦)) (set 120))
  (check-true (â‡“? fact-5 (â†¦) 120)))
